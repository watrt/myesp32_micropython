from machine import Pin, SPIfrom ili9163 import ILI9163_SPI,ILI9163import ujsonimport timeimport urequestsimport _threadimport framebufimport gcspi = SPI(1,baudrate=26000000,sck=Pin(33), mosi=Pin(25),miso=Pin(4))#spi = SPI(baudrate=26*1000*1000,sck=Pin(33), mosi=Pin(25),miso=Pin(4))  #miso=Pin(4)是无交的因为必须配置所以乱写的ili = ILI9163_SPI(128, 160, spi, res=Pin(27), dc=Pin(26), cs=Pin(4))main_show=Truespeed=30 #天气显示时间
def getnowtime():  import ntptime  import machine  ntptime.host="cn.ntppod.com"  rtc=machine.RTC()  ntptime.settime()  def showtime():  ili.fill(0xFFFF)  try:    if rtc.datetime()[0]<2020:      getnowtime()  #小于2020年就重新更新时间    ili.fill_rect(5,5,56,50,ili.brg(r=255))    ili.fill_rect(66,5,56,50,ili.brg(b=255))    ili.fill_rect(5,60,118,50,ili.brg(g=255))    ili.fill_rect(5,115,118,40,ili.brg(255,0,204))    ili.textst('%s' % nic.ifconfig()[0], 8, 120, 0xFFFF)    ili.textst('%s' % nic.ifconfig()[3], 8, 130, 0xFFFF)    ili.textst('%s' % nic.ifconfig()[2], 8, 140, 0xFFFF)    ili.textst('内存:', 70, 18, 0xFFFF)    ili.textst('%sKb' % (gc.mem_free()//1024), 70, 30, 0xFFFF)    ili.textst('HI!', 10, 16, ili.brg(b=255))    ili.textst('FUKUN!', 10, 26, ili.brg(b=255))    ili.textst('日期:%s-%s-%s'%(rtc.datetime()[0],rtc.datetime()[1],rtc.datetime()[2]), 8, 73, ili.brg(b=255))    ili.textst('时间:%s:%s:%s'%(rtc.datetime()[4],rtc.datetime()[5],rtc.datetime()[6]), 8, 88, ili.brg(b=255))  except:    ili.textst('错误!!', 10, 26, ili.brg(b=255))  finally:    ili.show()def showweather():  ili.fill(0x0000)  try:    #response = urequests.get('http://t.weather.sojson.com/api/weather/city/101270401')    response = urequests.get('http://api.seniverse.com/v3/weather/daily.json?key=SLKsx0pqQufxjVy9V&location=ip')    weather = ujson.loads(response.text)    response.close()    ili.fill(0x0000)        fs=open('weather/%s.bin' % (weather['results'][0]['daily'][0]['code_day']))    imgbyte=fs.read()    img=framebuf.FrameBuffer(bytearray(imgbyte),60,60,framebuf.RGB565)    ili.blit(img,68,0)    fs.close()    ili.hline(10,56,108,0xffff)    ili.textst('%s' % (weather['results'][0]['location']['name']), 10, 20,ili.brg(r=255))    ili.textst('%s' % (weather['results'][0]['daily'][0]['date']), 10, 3*13,ili.brg(g=255))    ili.textst('白天:%s' % (weather['results'][0]['daily'][0]['text_day']), 10, 5*13, 0xFFFF)    ili.textst('晚间:%s' % (weather['results'][0]['daily'][0]['text_night']), 10, 6*13, 0xFFFF)    ili.textst('晚间:%s' % (weather['results'][0]['daily'][0]['text_night']), 10, 7*13, 0xFFFF)    ili.textst('温度:%s至%s度' % (weather['results'][0]['daily'][0]['low'],weather['results'][0]['daily'][0]['high']), 10, 8*13, 0xFFFF)    ili.textst('湿度:%s百分比' % (weather['results'][0]['daily'][0]['humidity']), 10, 9*13, 0xFFFF)    ili.textst('风向:%s' % (weather['results'][0]['daily'][0]['wind_direction']), 10, 10*13, 0xFFFF)  except:    ili.textst('错误!!', 10, 26, ili.brg(r=255))    #ipinfo=list(nic.ifconfig()[0:3])    #ipinfo.append('223.5.5.5')  #更新阿里云DNS    #nic.ifconfig(ipinfo)  finally:    gc.collect()    ili.show()def mainshow(agv):    global main_show,speed    while main_show:      showtime()      time.sleep(5)      showweather()      time.sleep(speed)    _thread.exit()_thread.start_new_thread(mainshow,(1,))